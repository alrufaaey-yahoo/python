name: Build Android APK

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  ANDROID_COMPILE_SDK: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"
  ANDROID_SDK_TOOLS: "9477386"
  ANDROID_PLATFORM: "android-34"
  
  PYTHON_VERSION: "3.9"
  BUILDOZER_VERSION: "1.5.0"
  
  APP_NAME: "Turbo DDOS"
  APP_NAME_NO_SPACES: "Turbo_DDOS"
  PACKAGE_NAME: "com.alrufaaey.ddos"
  VERSION_CODE: 1
  VERSION_NAME: "1.0.0"

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: armeabi-v7a
            api: 21
            abi: armeabi-v7a
          - arch: arm64-v8a
            api: 21
            abi: arm64-v8a
          - arch: x86
            api: 21
            abi: x86
          - arch: x86_64
            api: 21
            abi: x86_64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Install system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential git zip unzip curl wget \
          python3-dev python3-pip python3-setuptools \
          openjdk-11-jdk \
          zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev \
          libssl-dev libreadline-dev libffi-dev libsqlite3-dev \
          libbz2-dev \
          pkg-config autoconf automake libtool cmake \
          ninja-build ccache swig patchelf

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer==${{ env.BUILDOZER_VERSION }}
        pip install cython==0.29.33

    - name: Set up Android SDK
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip -O cmdline-tools.zip
        mkdir -p ~/android-sdk/cmdline-tools
        unzip -q cmdline-tools.zip -d ~/android-sdk/cmdline-tools
        mv ~/android-sdk/cmdline-tools/cmdline-tools ~/android-sdk/cmdline-tools/latest
        rm cmdline-tools.zip
        
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "PATH=$PATH:$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools" >> $GITHUB_ENV

    - name: Accept Android SDK licenses
      run: |
        mkdir -p $HOME/android-sdk/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $HOME/android-sdk/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > $HOME/android-sdk/licenses/android-sdk-preview-license
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true

    - name: Install Android SDK components
      run: |
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --update
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;${{ env.ANDROID_PLATFORM }}" \
          "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
          "ndk;25.2.9519653" \
          "cmake;3.22.1"

    - name: Create clean buildozer.spec
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…ÙˆØ§ØµÙØ§Øª Ù†Ø¸ÙŠÙ Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
        if [ ! -f buildozer.spec.original ]; then
          cp buildozer.spec buildozer.spec.original
        fi
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ù Ù…Ø¤Ù‚Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ buildozer.spec Ù†Ø¸ÙŠÙ
        cat > buildozer.spec.tmp << 'EOF'
[app]

# Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
title = Turbo DDOS
package.name = ddos
package.domain = com.alrufaaey

# Ù…Ø³Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ø±
source.dir = ./src
source.include_exts = py,png,jpg,kv,txt,ttf,json

# Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
version.regex = __version__ = ['"]([^'"]*)['"]
version.filename = %(source.dir)s/main.py

# Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
requirements = python3,kivy==2.1.0,kivymd==1.1.1,pyjnius==1.4.2,openssl,requests==2.28.2,pillow==9.5.0

# ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
presplash.filename = ./assets/presplash.png
icon.filename = ./assets/ico.png
orientation = portrait
fullscreen = 0
log_level = 2

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Android
[android]

# Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
android.permissions = INTERNET,ACCESS_NETWORK_STATE,FOREGROUND_SERVICE,POST_NOTIFICATIONS,VIBRATE,WAKE_LOCK

# Ø¥ØµØ¯Ø§Ø±Ø§Øª API
android.api = $ANDROID_API
android.minapi = $ANDROID_MINAPI
android.sdk = 24
android.ndk = 25.2.9519653
android.ndk_api = 21

# Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
android.arch = $ANDROID_ARCH

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
android.private_storage = True
android.wakelock = True
android.allow_backup = True
android.accept_sdk_license = True

# ØªÙƒÙˆÙŠÙ† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (debug)
android.release_artifact = .apk

[buildozer]
log_level = 2
warn_on_root = 1
EOF
        
        # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        sed -i "s/\$ANDROID_ARCH/${{ matrix.arch }}/g" buildozer.spec.tmp
        sed -i "s/\$ANDROID_API/${{ matrix.api }}/g" buildozer.spec.tmp
        sed -i "s/\$ANDROID_MINAPI/${{ matrix.api }}/g" buildozer.spec.tmp
        
        mv buildozer.spec.tmp buildozer.spec
        echo "âœ… Created clean buildozer.spec for ${{ matrix.arch }}"
        echo "=== buildozer.spec content ==="
        cat buildozer.spec

    - name: Cache Buildozer dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          ~/.gradle
          ~/.android
        key: ${{ runner.os }}-buildozer-${{ matrix.arch }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-${{ matrix.arch }}-

    - name: Build APK with Buildozer
      run: |
        export PATH=$PATH:$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools
        export ANDROID_HOME=$HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export ANDROID_NDK_HOME=$HOME/android-sdk/ndk/25.2.9519653
        
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚
        echo "ðŸ§¹ Cleaning previous builds..."
        buildozer android clean 2>&1 | grep -v "WARNING" || true
        
        # Ø¨Ù†Ø§Ø¡ APK
        echo "ðŸš€ Starting Buildozer build for ${{ matrix.arch }}..."
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¹ Ø¥Ø®Ø±Ø§Ø¬ ØªÙØµÙŠÙ„ÙŠ
        if buildozer -v android debug 2>&1 | tee build.log; then
          echo "âœ… Build completed successfully!"
        else
          BUILD_EXIT_CODE=$?
          echo "âŒ Build failed with exit code: $BUILD_EXIT_CODE"
          echo "=== Last 50 lines of build.log ==="
          tail -50 build.log
          exit $BUILD_EXIT_CODE
        fi
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ APK
        if ls bin/*.apk 1> /dev/null 2>&1; then
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "âœ… APK built successfully: $(basename "$APK_FILE")"
          echo "ðŸ“Š APK size: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "âŒ No APK file found in bin/ directory!"
          ls -la bin/ || true
          exit 1
        fi

    - name: Rename APK with architecture info
      run: |
        APK_FILE=$(ls bin/*.apk | head -1)
        NEW_NAME="${{ env.APP_NAME_NO_SPACES }}-v${{ env.VERSION_NAME }}-${{ matrix.abi }}-debug.apk"
        mv "$APK_FILE" "bin/$NEW_NAME"
        echo "âœ… Renamed APK to: $NEW_NAME"

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-${{ matrix.abi }}-debug
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: error

  # Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ (build-universal, release, quality-check, notification)
  build-universal:
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all APK artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create universal package
      run: |
        mkdir -p universal
        find artifacts -name "*.apk" -exec cp {} universal/ \;
        
        cat > universal/README.md << EOF
        # ${{ env.APP_NAME }} APKs
        Version: ${{ env.VERSION_NAME }}
        Build: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        EOF
        
        cd universal
        zip -r ../${{ env.APP_NAME_NO_SPACES }}-v${{ env.VERSION_NAME }}-all-archs.zip .
        cd ..

    - name: Upload universal package
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Universal
        path: ${{ env.APP_NAME_NO_SPACES }}-v${{ env.VERSION_NAME }}-all-archs.zip
        retention-days: 30

  quality-check:
    runs-on: ubuntu-latest
    needs: build-android
    
    steps:
    - name: Download APK for checking
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-arm64-v8a-debug
        path: apk-check

    - name: Basic APK validation
      run: |
        APK_FILE=$(find apk-check -name "*.apk" | head -1)
        if [ -f "$APK_FILE" ]; then
          echo "âœ… APK exists: $(basename "$APK_FILE")"
          echo "ðŸ“ Size: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "âŒ No APK found"
          exit 1
        fi
