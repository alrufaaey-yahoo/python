name: Build Android APK

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

env:
  # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥ØµØ¯Ø§Ø± Android SDK
  ANDROID_COMPILE_SDK: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"
  ANDROID_SDK_TOOLS: "9477386"
  ANDROID_PLATFORM: "android-34"
  
  # Ø¥ØµØ¯Ø§Ø±Ø§Øª Python Ùˆ Buildozer
  PYTHON_VERSION: "3.9"
  BUILDOZER_VERSION: "1.5.0"
  
  # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª App
  APP_NAME: "Turbo DDOS"
  APP_NAME_NO_SPACES: "Turbo_DDOS"  # Ø§Ø³Ù… Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª
  PACKAGE_NAME: "com.alrufaaey.ddos"
  VERSION_CODE: 1
  VERSION_NAME: "1.0.0"

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9]
        include:
          - arch: armeabi-v7a
            api: 21
            abi: armeabi-v7a
          - arch: arm64-v8a
            api: 21
            abi: arm64-v8a
          - arch: x86
            api: 21
            abi: x86
          - arch: x86_64
            api: 21
            abi: x86_64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential \
          git \
          zip \
          unzip \
          curl \
          wget \
          python3-dev \
          python3-pip \
          python3-setuptools \
          openjdk-11-jdk \
          zlib1g-dev \
          libncurses5-dev \
          libgdbm-dev \
          libnss3-dev \
          libssl-dev \
          libreadline-dev \
          libffi-dev \
          libsqlite3-dev \
          libbz2-dev \
          pkg-config \
          autoconf \
          automake \
          libtool \
          cmake \
          ninja-build \
          ccache \
          swig \
          patchelf

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install buildozer==${{ env.BUILDOZER_VERSION }}
        pip install cython==0.29.33

    - name: Set up Android SDK
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        # Download and install Android Command Line Tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip -O cmdline-tools.zip
        mkdir -p ~/android-sdk/cmdline-tools
        unzip -q cmdline-tools.zip -d ~/android-sdk/cmdline-tools
        mv ~/android-sdk/cmdline-tools/cmdline-tools ~/android-sdk/cmdline-tools/latest
        rm cmdline-tools.zip
        
        # Set environment variables
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "PATH=$PATH:$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools" >> $GITHUB_ENV

    - name: Accept Android SDK licenses
      run: |
        # Create a licenses directory and accept licenses
        mkdir -p $HOME/android-sdk/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $HOME/android-sdk/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > $HOME/android-sdk/licenses/android-sdk-preview-license
        echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $HOME/android-sdk/licenses/intel-android-extra-license
        
        # Also accept via sdkmanager
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true

    - name: Install Android SDK components
      run: |
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --update
        
        # Install essential components only (patcher;v4 removed)
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;${{ env.ANDROID_PLATFORM }}" \
          "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
          "ndk;25.2.9519653" \
          "cmake;3.22.1"
        
        # Verify installation
        echo "Android SDK components installed:"
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --list --verbose | grep -E "Installed|installed"

    - name: Configure Buildozer
      run: |
        # Create buildozer.spec if it doesn't exist
        if [ ! -f buildozer.spec ]; then
          buildozer init
        fi
        
        # Update buildozer.spec with matrix values
        sed -i "s/^android.arch = .*/android.arch = ${{ matrix.arch }}/" buildozer.spec
        sed -i "s/^android.api = .*/android.api = ${{ matrix.api }}/" buildozer.spec
        sed -i "s/^android.minapi = .*/android.minapi = ${{ matrix.api }}/" buildozer.spec
        sed -i "s/^title = .*/title = ${{ env.APP_NAME }}/" buildozer.spec
        sed -i "s/^package.name = .*/package.name = ${{ env.PACKAGE_NAME }}/" buildozer.spec
        sed -i "s/^package.domain = .*/package.domain = com.alrufaaey/" buildozer.spec
        sed -i "s/^version.regex = .*/version.regex = __version__ = ['\"]([^'\"]*)['\"]/" buildozer.spec
        
        # Configure for debug build
        sed -i "s/^android.release_artifact = .*/android.release_artifact = .apk/" buildozer.spec
        
        # Ensure proper requirements section
        if grep -q "^requirements = " buildozer.spec; then
          sed -i "s|^requirements = .*|requirements = python3,kivy==2.1.0,kivymd==1.1.1,pyjnius==1.4.2,openssl,requests==2.28.2,pillow==9.5.0|" buildozer.spec
        else
          echo "" >> buildozer.spec
          echo "# Python dependencies" >> buildozer.spec
          echo "requirements = python3,kivy==2.1.0,kivymd==1.1.1,pyjnius==1.4.2,openssl,requests==2.28.2,pillow==9.5.0" >> buildozer.spec
        fi

    - name: Cache Buildozer dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          ~/.gradle
          ~/.android
          ~/.local/share/virtualenvs
        key: ${{ runner.os }}-buildozer-${{ matrix.arch }}-${{ hashFiles('buildozer.spec', 'requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-${{ matrix.arch }}-
          ${{ runner.os }}-buildozer-

    - name: Build APK with Buildozer
      run: |
        export PATH=$PATH:$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools
        export ANDROID_HOME=$HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export ANDROID_NDK_HOME=$HOME/android-sdk/ndk/25.2.9519653
        
        # Clean previous builds
        buildozer android clean || true
        
        # Build debug APK with verbose output
        echo "Starting Buildozer build for ${{ matrix.arch }}..."
        buildozer -v android debug 2>&1 | tee build.log
        
        # Check if APK was created
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "âœ… APK built successfully!"
          ls -la bin/
          
          # Check APK size
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "APK size: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "âŒ APK build failed!"
          echo "Build log tail:"
          tail -50 build.log
          exit 1
        fi

    - name: Rename APK with architecture info
      run: |
        # Find the built APK
        APK_FILE=$(ls bin/*.apk | head -1)
        NEW_NAME="${{ env.APP_NAME_NO_SPACES }}-v${{ env.VERSION_NAME }}-${{ matrix.abi }}-debug.apk"
        
        mv "$APK_FILE" "bin/$NEW_NAME"
        echo "âœ… APK renamed to: $NEW_NAME"

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-${{ matrix.abi }}-debug
        path: bin/*.apk
        retention-days: 7

  build-universal:
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all APK artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create universal APK (Android App Bundle simulation)
      run: |
        mkdir -p universal
        UNIVERSAL_DIR="universal"
        
        # Copy all APKs to universal directory
        find artifacts -name "*.apk" -exec cp {} $UNIVERSAL_DIR/ \;
        
        # Create README with build info
        cat > $UNIVERSAL_DIR/README.md << EOF
        # ${{ env.APP_NAME }} - Universal APKs
        
        ## Build Information
        - **App Name:** ${{ env.APP_NAME }}
        - **Version:** ${{ env.VERSION_NAME }}
        - **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Commit:** ${{ github.sha }}
        - **Run ID:** ${{ github.run_id }}
        
        ## Available Architectures:
        
        EOF
        
        # List all APKs in README
        for apk in $UNIVERSAL_DIR/*.apk; do
          echo "- $(basename "$apk")" >> $UNIVERSAL_DIR/README.md
        done
        
        echo "" >> $UNIVERSAL_DIR/README.md
        echo "## Installation Instructions:" >> $UNIVERSAL_DIR/README.md
        echo "1. Download the APK matching your device architecture:" >> $UNIVERSAL_DIR/README.md
        echo "   - **arm64-v8a**: Most modern phones (2016+)" >> $UNIVERSAL_DIR/README.md
        echo "   - **armeabi-v7a**: Older phones" >> $UNIVERSAL_DIR/README.md
        echo "   - **x86/x86_64**: Emulators and Android TV" >> $UNIVERSAL_DIR/README.md
        echo "2. Enable 'Install from unknown sources' in Android settings" >> $UNIVERSAL_DIR/README.md
        echo "3. Install the APK" >> $UNIVERSAL_DIR/README.md
        
        # Create a zip with all APKs
        cd $UNIVERSAL_DIR
        zip -r ../${{ env.APP_NAME_NO_SPACES }}-v${{ env.VERSION_NAME }}-all-architectures.zip .
        cd ..

    - name: Upload universal package
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Universal-All-Archs
        path: |
          ${{ env.APP_NAME_NO_SPACES }}-v${{ env.VERSION_NAME }}-all-architectures.zip
          universal/
        retention-days: 30

  release:
    runs-on: ubuntu-latest
    needs: build-universal
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download universal artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Universal-All-Archs
        path: release-artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-artifacts/${{ env.APP_NAME_NO_SPACES }}-v${{ env.VERSION_NAME }}-all-architectures.zip
          release-artifacts/universal/*.apk
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          # ${{ env.APP_NAME }} v${{ env.VERSION_NAME }}
          
          ## ğŸ“± ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø¬ÙˆÙ… DDOS Ù…ØªÙ‚Ø¯Ù…
          
          ### Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:
          - Ù‡Ø¬ÙˆÙ… HTTP/HTTPS Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠÙˆØ·
          - ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø±Ø¨ÙŠØ©
          - Ø¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Android
          - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          
          ### Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:
          1. Ø­Ù…Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø¬Ù‡Ø§Ø²Ùƒ
          2. ÙØ¹Ù‘Ù„ "Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ù† Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"
          3. Ø«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø³ØªÙ…ØªØ¹
          
          ### âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:
          Ù„Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙÙ‚Ø·

  quality-check:
    runs-on: ubuntu-latest
    needs: build-android
    
    steps:
    - name: Download APK artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-arm64-v8a-debug
        path: apk-check

    - name: APK Structure Check
      run: |
        APK_FILE=$(find apk-check -name "*.apk" | head -1)
        
        if [ -f "$APK_FILE" ]; then
          echo "âœ… APK file found: $(basename "$APK_FILE")"
          echo "ğŸ“Š File size: $(du -h "$APK_FILE" | cut -f1)"
          
          # Check APK structure (basic)
          if unzip -l "$APK_FILE" | grep -q "AndroidManifest.xml"; then
            echo "âœ… AndroidManifest.xml found"
          else
            echo "âŒ AndroidManifest.xml missing"
            exit 1
          fi
          
          if unzip -l "$APK_FILE" | grep -q "classes.dex"; then
            echo "âœ… classes.dex found"
          else
            echo "âŒ classes.dex missing"
            exit 1
          fi
          
          if unzip -l "$APK_FILE" | grep -q "resources.arsc"; then
            echo "âœ… resources.arsc found"
          else
            echo "âŒ resources.arsc missing"
            exit 1
          fi
          
          echo "âœ… APK structure check passed!"
        else
          echo "âŒ APK file not found!"
          exit 1
        fi

    - name: Security Scan (Basic)
      run: |
        APK_FILE=$(find apk-check -name "*.apk" | head -1)
        
        echo "ğŸ”’ Running basic security checks..."
        
        # Check for dangerous permissions
        if which aapt > /dev/null 2>&1; then
          echo "ğŸ“‹ APK Permissions:"
          aapt d permissions "$APK_FILE" 2>/dev/null || echo "âš ï¸ Could not extract permissions"
        else
          echo "â„¹ï¸ aapt not found, skipping permission check"
        fi

  notification:
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build Status Notification
      uses: actions/github-script@v6
      with:
        script: |
          const jobStatus = '${{ job.status }}';
          const workflow = '${{ github.workflow }}';
          const repo = '${{ github.repository }}';
          const runId = '${{ github.run_id }}';
          const commitMsg = '${{ github.event.head_commit.message }}' || 'Manual trigger';
          const ref = '${{ github.ref }}';
          const tag = ref.startsWith('refs/tags/') ? ref.replace('refs/tags/', '') : null;
          
          let message = `ğŸš€ *${workflow}* - Build ${jobStatus}\n`;
          message += `ğŸ“¦ Repository: ${repo}\n`;
          message += `ğŸ”— Run: https://github.com/${repo}/actions/runs/${runId}\n`;
          
          if (tag) {
            message += `ğŸ·ï¸ Tag: ${tag}\n`;
          }
          
          message += `ğŸ“ Commit: ${commitMsg.substring(0, 100)}...\n`;
          
          if (jobStatus === 'success') {
            message += `âœ… *Build Successful!*\n`;
            message += `ğŸ“± APK artifacts are available in the workflow run.\n`;
            message += `â¬‡ï¸ Download from the Artifacts section.`;
          } else if (jobStatus === 'failure') {
            message += `âŒ *Build Failed!*\n`;
            message += `ğŸ” Check the workflow logs for details.\n`;
            message += `ğŸ“‹ Error details in the logs above.`;
          } else {
            message += `âš ï¸ *Build ${jobStatus.toUpperCase()}*\n`;
            message += `â„¹ï¸ Check the workflow for details.`;
          }
          
          // Log message (you can add webhook notifications here)
          console.log('=== BUILD NOTIFICATION ===');
          console.log(message);
          console.log('==========================');
          
          // For webhook integration (uncomment and configure as needed):
          /*
          // Example for Discord webhook
          const webhookUrl = process.env.DISCORD_WEBHOOK_URL;
          if (webhookUrl) {
            const payload = {
              content: message,
              username: 'GitHub Actions',
              avatar_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
            };
            
            await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
          }
          */
